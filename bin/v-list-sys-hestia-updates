#!/bin/bash
# info: list system updates
# options: [FORMAT]
#
# The function checks available updates for hestia packages.


#----------------------------------------------------------#
#                    Variable&Function                     #
#----------------------------------------------------------#

# Argument definition
format=${1-shell}

# Includes
source $HESTIA/func/main.sh
source $HESTIA/conf/hestia.conf
fields="\$NAME \$VERSION \$RELEASE \$ARCH \$UPDATED \$DESCR \$TIME \$DATE"

# JSON list function
json_list() {
    IFS=$'\n'
    i=1
    objects=$(echo -e "$data" |grep NAME |wc -l)
    echo "{"
    for str in $(echo -e "$data"); do
        eval $str
        echo -n '    "'$NAME'": {
        "VERSION": "'$VERSION'",
        "RELEASE": "'$RELEASE'",
        "ARCH": "'$ARCH'",
        "UPDATED": "'$UPDATED'",
        "DESCR": "'$DESCR'",
        "TIME": "'$TIME'",
        "DATE": "'$DATE'"
    }'
        if [ "$i" -lt "$objects" ]; then
            echo ','
        else
            echo
        fi
        ((i++))
    done
    echo '}'
}

# SHELL list function
shell_list() {
    IFS=$'\n'
    echo "PKG   VER   REL   ARCH   UPDT   DATE"
    echo "---   ---   ---   ----   ----   ----"
    for str in $(echo -e "$data"); do
        eval $str
        echo "$NAME $VERSION $RELEASE $ARCH $UPDATED $DATE"
    done
}


#----------------------------------------------------------#
#                       Action                             #
#----------------------------------------------------------#

# Checking official latest version
if [ "$RELEASE_BRANCH" != "release" ]; then
    branch_check=$(curl -s --head -w %{http_code} https://raw.githubusercontent.com/hestiacp/hestiacp/$RELEASE_BRANCH/src/deb/hestia/control -o /dev/null)
    if [ $branch_check -ne "200" ]; then
        echo "Error: invalid branch name specified."
        exit 1
    else
        branch=$RELEASE_BRANCH
    fi
    hestia_v=$(curl -s https://raw.githubusercontent.com/hestiacp/hestiacp/$branch/src/deb/hestia/control | grep "Version:" | cut -d' ' -f2 | xargs)
else
    hestia_v=$(apt-cache policy hestia | grep Candidate | cut -d ':' -f 2 | xargs)
fi

nginx_v=$(apt-cache policy hestia-nginx | grep Candidate | cut -d ':' -f 2 | xargs)
php_v=$(apt-cache policy hestia-php | grep Candidate | cut -d ':' -f 2 | xargs)

# Checking installed hestia version
if [ -d "/etc/sysconfig" ]; then
    rpm_format="VERSION='%{VERSION}'"
    rpm_format="$rpm_format RELEASE='%{RELEASE}'"
    rpm_format="$rpm_format ARCH='%{ARCH}'"
    rpm_format="$rpm_format UTIME='%{INSTALLTIME}'\n"
    eval $(rpm --queryformat="$rpm_format" -q hestia)
    DATE=$(date -d @$UTIME +%F)
    TIME=$(date -d @$UTIME +%T)
else
    dpkg_data=$(dpkg-query -s hestia)
    pkg_date=$(stat -c "%Y" /var/lib/dpkg/info/hestia.list)
    ARCH=$(echo "$dpkg_data"|grep Architecture |cut -f 2 -d ' ')
    VERSION=$(echo "$dpkg_data"|grep ^Version |cut -f 2 -d ' '|cut -f 1 -d \-)
    RELEASE=$(echo "$dpkg_data"|grep ^Version |cut -f 2 -d ' '|cut -f 2 -d \-)
    RELEASE_B=$(echo $RELEASE_BRANCH)
    DATE=$(date -d @$pkg_date +"%F")
    TIME=$(date -d @$pkg_date +"%T")
fi
UPDATED='yes'
if [ ! -z "$hesta_v" ] && [ "$hestia_v" \> "$VERSION-$RELEASE" ]; then
    UPDATED='no'
fi
data="NAME='hestia' VERSION='$VERSION' RELEASE='$RELEASE' ARCH='$ARCH'"
data="$data UPDATED='$UPDATED' DESCR='core package' TIME='$TIME' DATE='$DATE'"

# Checking installed hestia-php version
if [ -d "/etc/sysconfig" ]; then
    eval $(rpm --queryformat="$rpm_format" -q hestia-php)
    DATE=$(date -d @$UTIME +%F)
    TIME=$(date -d @$UTIME +%T)
else
    dpkg_data=$(dpkg-query -s hestia-php)
    pkg_date=$(stat -c "%Y" /var/lib/dpkg/info/hestia-php.list)
    ARCH=$(echo "$dpkg_data"|grep Architecture | cut -f 2 -d ' ')
    VERSION=$(echo "$dpkg_data"|grep ^Version |cut -f 2 -d ' '|cut -f 1 -d \-)
    RELEASE=$(echo "$dpkg_data"|grep ^Version |cut -f 2 -d ' '|cut -f 2 -d \-)
    DATE=$(date -d @$pkg_date +"%F")
    TIME=$(date -d @$pkg_date +"%T")
fi
UPDATED='yes'
if [ ! -z "$php_v" ] && [ "$php_v" \> "$VERSION-$RELEASE" ]; then
    UPDATED='no'
fi
data="$data\nNAME='hestia-php' VERSION='$VERSION' RELEASE='$RELEASE'"
data="$data ARCH='$ARCH' UPDATED='$UPDATED' DESCR='php interpreter'"
data="$data TIME='$TIME' DATE='$DATE'"

# Checking installed hestia-nginx version
if [ -d "/etc/sysconfig" ]; then
    eval $(rpm --queryformat="$rpm_format" -q hestia-nginx)
    DATE=$(date -d @$UTIME +%F)
    TIME=$(date -d @$UTIME +%T)
else
    dpkg_data=$(dpkg-query -s hestia-nginx)
    pkg_date=$(stat -c "%Y" /var/lib/dpkg/info/hestia-nginx.list)
    ARCH=$(echo "$dpkg_data"|grep Architecture | cut -f 2 -d ' ')
    VERSION=$(echo "$dpkg_data"|grep ^Version |cut -f 2 -d ' '|cut -f 1 -d \-)
    RELEASE=$(echo "$dpkg_data"|grep ^Version |cut -f 2 -d ' '|cut -f 2 -d \-)
    DATE=$(date -d @$pkg_date +"%F")
    TIME=$(date -d @$pkg_date +"%T")
fi
UPDATED='yes'
if [ ! -z "$nginx_v" ] && [ "$nginx_v" \> "$VERSION-$RELEASE" ]; then
    UPDATED='no'
fi
data="$data\nNAME='hestia-nginx' VERSION='$VERSION' RELEASE='$RELEASE'"
data="$data ARCH='$ARCH' UPDATED='$UPDATED' DESCR='internal web server'"
data="$data TIME='$TIME' DATE='$DATE'"

# Listing data
case $format in
    json)   json_list ;;
    plain)  plain_list ;;
    csv)    csv_list ;;
    shell)  shell_list |column -t;;
esac


#----------------------------------------------------------#
#                       Hestia                             #
#----------------------------------------------------------#

exit
